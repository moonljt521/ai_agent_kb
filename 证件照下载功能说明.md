# 证件照下载功能说明

## 功能概述

证件照生成后，系统会提供一个可直接下载的 HTTP 链接，用户可以通过浏览器或其他工具下载生成的证件照。

## 架构设计

### 双服务架构

为了解决 Gradio 框架的文件服务限制，我们采用了双服务架构：

1. **Gradio 服务** (端口 7860)
   - 提供 Web 界面
   - 处理用户交互
   - 调用 Agent 生成证件照

2. **文件服务器** (端口 8000)
   - 独立的 FastAPI 服务
   - 专门用于提供文件下载
   - 支持中文文件名（UTF-8 编码）

### 为什么需要独立文件服务器？

Gradio 的 `allowed_paths` 参数只允许在 Gradio 组件（如 Image、File）中显示文件，但不支持直接的 HTTP 下载链接。尝试通过 FastAPI 路由添加到 Gradio 的 app 对象也会被 Gradio 的路由系统覆盖。

因此，我们创建了一个独立的文件服务器来专门处理文件下载请求。

## 技术实现

### 1. 文件服务器 (`file_server.py`)

```python
from fastapi import FastAPI
from fastapi.responses import FileResponse
import urllib.parse

app = FastAPI()

@app.get("/photos/{filename:path}")
async def serve_photo(filename: str):
    """提供证件照下载"""
    file_path = os.path.join("app/static/photos", filename)
    if os.path.exists(file_path):
        # URL encode 文件名以支持中文
        encoded_filename = urllib.parse.quote(os.path.basename(filename))
        return FileResponse(
            file_path,
            media_type="image/jpeg",
            headers={
                "Content-Disposition": f"attachment; filename*=UTF-8''{encoded_filename}",
                "Access-Control-Allow-Origin": "*"
            }
        )
    return {"error": "File not found"}
```

**关键点：**
- 使用 `filename*=UTF-8''` 格式支持中文文件名（RFC 5987）
- 使用 `urllib.parse.quote()` 对文件名进行 URL 编码
- 添加 CORS 头支持跨域访问

### 2. 工具集成 (`app/core/tools.py`)

```python
@tool
def generate_id_photo(...):
    # ... 生成证件照 ...
    
    # 生成下载链接
    filename = os.path.basename(filepath)
    download_url = f"http://localhost:8000/photos/{filename}"
    
    result = f"""✅ Successfully generated {size} ID photo!
    
📥 Download: {download_url}

[IMAGE_PATH:{filepath}]
"""
    return result
```

### 3. 启动脚本 (`start_all_services.sh`)

```bash
#!/bin/bash
# 启动文件服务器
python3 -B file_server.py > /tmp/file_server.log 2>&1 &

# 启动 Gradio 界面
python3 -B app_gradio.py > /tmp/gradio.log 2>&1 &
```

## 使用方法

### 启动服务

```bash
# 方式 1: 使用启动脚本（推荐）
./start_all_services.sh

# 方式 2: 手动启动
# 终端 1: 启动文件服务器
python3 -B file_server.py

# 终端 2: 启动 Gradio 界面
python3 -B app_gradio.py
```

### 生成和下载证件照

1. 访问 http://localhost:7860
2. 上传照片
3. 输入要求，例如："生成1寸白底证件照"
4. Agent 会返回下载链接，例如：
   ```
   📥 Download: http://localhost:8000/photos/id_photo_1寸_white_20260203_154550.jpg
   ```
5. 点击链接或复制到浏览器即可下载

### 测试下载功能

```bash
# 运行测试脚本
python3 -B test_download_link.py
```

## 文件存储

生成的证件照保存在：
- **路径**: `app/static/photos/`
- **命名格式**: `id_photo_{尺寸}_{颜色}_{时间戳}.jpg`
- **示例**: `id_photo_1寸_white_20260203_154550.jpg`

上传的原始照片保存在：
- **路径**: `app/static/uploads/`
- **命名格式**: `upload_{时间戳}.jpg`

## API 端点

### 文件服务器 (端口 8000)

| 端点 | 方法 | 说明 |
|------|------|------|
| `/photos/{filename}` | GET | 下载证件照 |
| `/uploads/{filename}` | GET | 下载上传的原始照片 |
| `/health` | GET | 健康检查 |

### 示例请求

```bash
# 下载证件照
curl -O "http://localhost:8000/photos/id_photo_1寸_white_20260203_154550.jpg"

# 健康检查
curl "http://localhost:8000/health"
# 返回: {"status":"ok","service":"ID Photo File Server"}
```

## 故障排查

### 问题 1: 下载链接返回 404

**原因**: 文件服务器未启动

**解决**:
```bash
# 检查文件服务器是否运行
ps aux | grep file_server.py

# 如果没有运行，启动它
python3 -B file_server.py &
```

### 问题 2: 下载链接返回 500 错误

**原因**: 文件名包含中文字符，编码问题

**解决**: 已在 `file_server.py` 中使用 UTF-8 编码处理，确保使用最新版本

### 问题 3: 文件不存在

**原因**: 证件照生成失败或文件被删除

**解决**:
```bash
# 检查文件是否存在
ls -lh app/static/photos/

# 重新生成证件照
```

### 问题 4: CORS 错误

**原因**: 跨域访问被阻止

**解决**: 文件服务器已添加 CORS 头，如果仍有问题，检查浏览器控制台

## 性能优化

### 文件清理

生成的证件照会累积占用磁盘空间，建议定期清理：

```bash
# 清理 7 天前的文件
find app/static/photos -name "id_photo_*.jpg" -mtime +7 -delete
find app/static/uploads -name "upload_*.jpg" -mtime +7 -delete
```

### 缓存策略

可以在文件服务器中添加缓存头：

```python
return FileResponse(
    file_path,
    media_type="image/jpeg",
    headers={
        "Cache-Control": "public, max-age=3600",  # 缓存 1 小时
        ...
    }
)
```

## 安全考虑

1. **路径遍历防护**: FastAPI 的 `{filename:path}` 参数会自动处理路径遍历攻击
2. **文件类型限制**: 只提供 JPEG 图片下载
3. **文件大小限制**: 证件照文件通常小于 1MB
4. **访问控制**: 当前为开放访问，生产环境建议添加认证

## 未来改进

1. **CDN 集成**: 将文件上传到 CDN，提供更快的下载速度
2. **临时链接**: 生成带过期时间的临时下载链接
3. **批量下载**: 支持一次下载多个尺寸的证件照
4. **水印功能**: 在下载前添加水印
5. **格式转换**: 支持下载 PNG、WebP 等其他格式

## 总结

通过独立的文件服务器，我们成功实现了：
- ✅ 可直接下载的 HTTP 链接
- ✅ 支持中文文件名
- ✅ 跨域访问支持
- ✅ 简单易用的 API
- ✅ 与 Gradio 界面无缝集成

这个方案简单、可靠，适合当前的应用场景。
