# 📸 证件照功能完整使用指南

## 快速开始

### 1. 启动服务
```bash
python app_gradio.py
```
服务将在 http://localhost:7860 启动

### 2. 使用步骤
1. 打开浏览器访问 http://localhost:7860
2. 在右侧"证件照生成"区域上传照片
3. 在对话框输入："生成1寸白底证件照"
4. 查看生成的证件照（直接显示在聊天框中）
5. 点击下载链接保存照片

## 功能特性

### ✅ 已实现的功能
1. **图片上传** - 支持 JPG、PNG 等格式
2. **智能生成** - 自动人脸检测和裁剪
3. **多种规格** - 10+ 种标准尺寸
4. **多种背景** - 白色、蓝色、红色、浅蓝
5. **聊天框显示** - 生成的照片直接显示
6. **文件下载** - 提供可点击的下载链接
7. **高质量输出** - 300 DPI，JPEG 95%

### 支持的尺寸
- 1寸: 295 x 413 px
- 小1寸: 260 x 378 px
- 2寸: 413 x 579 px
- 小2寸: 378 x 567 px
- 大1寸: 390 x 567 px
- 护照: 354 x 472 px
- 身份证: 358 x 441 px
- 驾驶证: 260 x 378 px
- 社保卡: 358 x 441 px
- 教师资格证: 295 x 413 px

### 支持的背景颜色
- 白色 (RGB: 255, 255, 255)
- 蓝色 (RGB: 67, 142, 219)
- 红色 (RGB: 255, 0, 0)
- 浅蓝 (RGB: 173, 216, 230)

## 使用示例

### 示例1: 生成1寸白底证件照
```
用户: 生成1寸白底证件照
AI: ✅ 已成功生成 1寸 白色底证件照！
    📏 尺寸：295 x 413 px
    📥 下载链接：/static/photos/id_photo_xxx.jpg
    [显示图片]
```

### 示例2: 生成多个规格
```
用户: 生成1寸白底证件照
AI: [生成成功，显示图片]

用户: 再生成一个2寸蓝底的
AI: [生成成功，显示图片]
```

### 示例3: 查询支持的规格
```
用户: 支持哪些证件照规格？
AI: [列出所有支持的尺寸和背景颜色]
```

## 技术实现

### 工作流程
```
用户上传照片
  ↓
保存到 app/static/uploads/
  ↓
用户发送生成请求
  ↓
Gradio 添加图片路径到消息
  ↓
Agent 解析请求并调用工具
  ↓
generate_id_photo 工具处理
  ↓
生成证件照保存到 app/static/photos/
  ↓
返回结果（包含图片路径标记）
  ↓
Agent 提取图片路径
  ↓
chat 函数转换为 Markdown 格式
  ↓
Gradio 渲染并显示图片
```

### 关键技术点

#### 1. 静态文件服务
```python
demo.launch(
    allowed_paths=["app/static/photos", "app/static/uploads"]
)
```

#### 2. 图片路径标记
```python
# 工具返回
result = f"""...
[IMAGE_PATH:{filepath}]
..."""
```

#### 3. 路径提取
```python
# Agent 从 intermediate_steps 提取
for action, observation in result['intermediate_steps']:
    if "[IMAGE_PATH:" in observation:
        # 提取并添加到答案
```

#### 4. Markdown 转换
```python
# chat 函数转换
image_match = re.search(r'\[IMAGE_PATH:(.*?)\]', answer)
if image_match:
    answer += f"\n\n![生成的证件照]({image_path})"
```

## 测试

### 运行测试
```bash
# 完整功能测试
python test_id_photo_with_agent.py

# 图片显示测试
python test_image_display.py

# 快速验证
python verify_all_fixed.py
```

### 测试检查项
- ✅ 图片上传成功
- ✅ 证件照生成成功
- ✅ 图片路径标记存在
- ✅ 下载链接可访问
- ✅ 图片在聊天框显示
- ✅ 无异常或错误

## 故障排除

### 问题1: 图片不显示
**可能原因**:
- 文件未生成
- 路径错误
- allowed_paths 未配置

**解决方法**:
1. 检查 `app/static/photos/` 目录
2. 查看控制台日志
3. 重启 Gradio 服务

### 问题2: 下载链接 404
**可能原因**:
- 服务未重启
- 路径格式错误
- 文件权限问题

**解决方法**:
1. 重启服务应用配置
2. 检查路径格式（应以 `/static/` 开头）
3. 检查文件权限

### 问题3: 生成失败
**可能原因**:
- 图片未上传
- 人脸检测失败
- 依赖缺失

**解决方法**:
1. 确认图片已上传
2. 使用清晰的正面照
3. 运行 `./install_id_photo_deps.sh`

### 问题4: Agent 达到迭代限制
**可能原因**:
- LLM 输出格式错误
- 提示词不清晰

**解决方法**:
- 已通过改进提示词解决
- 如仍出现，检查 LLM 配置

## 最佳实践

### 照片要求
1. **正面免冠照**
2. **人脸清晰可见**
3. **光线充足均匀**
4. **背景简单干净**
5. **高分辨率（建议 > 500px）**

### 使用建议
1. **先上传照片** - 确保看到上传成功提示
2. **明确需求** - 清楚说明尺寸和背景颜色
3. **一次一个** - 避免同时请求多个规格
4. **及时下载** - 生成后立即下载保存

### 性能优化
1. **图片大小** - 原图不要超过 5MB
2. **批量生成** - 可以连续生成多个规格
3. **清理文件** - 定期清理 uploads 和 photos 目录

## 文件结构

```
ai_agent_kb/
├── app/
│   ├── core/
│   │   ├── agent.py          # Agent 主逻辑
│   │   ├── tools.py           # 工具定义（包含 generate_id_photo）
│   │   └── id_photo.py        # 证件照生成核心
│   ├── static/
│   │   ├── uploads/           # 用户上传的照片
│   │   └── photos/            # 生成的证件照
│   └── main.py
├── app_gradio.py              # Gradio 界面
├── test_id_photo_with_agent.py
├── test_image_display.py
└── 证件照功能完整指南.md     # 本文档
```

## 更新日志

### 2026-02-02
- ✅ 实现证件照生成功能
- ✅ 添加图片上传功能
- ✅ 实现聊天框图片显示
- ✅ 修复下载链接 404 问题
- ✅ 优化 Agent 推理流程
- ✅ 改进错误处理和提示

## 相关文档
- `证件照功能使用说明.md` - 基础使用说明
- `证件照显示和下载说明.md` - 技术实现细节
- `本次会话完成总结.md` - 问题修复总结

## 支持

如有问题，请：
1. 查看控制台日志
2. 运行测试脚本诊断
3. 检查文件权限和路径
4. 参考故障排除章节

---

🎉 享受使用证件照生成功能！
