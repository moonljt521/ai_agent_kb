# 📸 证件照生成功能说明

## 🎉 新功能介绍

我们在 `feature/id-photo-generator` 分支上开发了一个全新的证件照生成功能！

### ✨ 核心特性

1. **智能人脸检测** - 自动识别人脸位置并智能裁剪
2. **背景移除** - 一键移除原背景，替换为纯色背景
3. **多种规格** - 支持 10+ 种标准证件照尺寸
4. **多种背景** - 白色、蓝色、红色、浅蓝 4 种背景色
5. **质量增强** - 自动锐化和对比度增强
6. **高清输出** - 300 DPI 高清输出

## 📋 支持的规格

### 证件照尺寸

| 规格 | 尺寸 (px) | 用途 |
|------|----------|------|
| 1寸 | 295×413 | 简历、学生证 |
| 小1寸 | 260×378 | 港澳通行证 |
| 2寸 | 413×579 | 毕业证、档案 |
| 小2寸 | 378×567 | 普通证件 |
| 大1寸 | 390×567 | 签证申请 |
| 护照 | 354×472 | 护照申请 |
| 身份证 | 358×441 | 身份证 |
| 驾驶证 | 260×378 | 驾驶证 |
| 社保卡 | 358×441 | 社保卡 |
| 教师资格证 | 295×413 | 教师资格证 |

### 背景颜色

- 🤍 **白色** - 最常用，适合大多数证件
- 💙 **蓝色** - 签证、护照常用
- ❤️ **红色** - 部分证件要求
- 💠 **浅蓝** - 柔和背景

## 🚀 快速开始

### 1. 安装依赖

```bash
# 方式一：使用安装脚本（推荐）
./install_id_photo_deps.sh

# 方式二：手动安装
pip install Pillow opencv-python numpy rembg gradio
```

### 2. 运行测试

```bash
# 基础功能测试
python test_id_photo.py

# 如果有真实照片，命名为 test_photo.jpg 放在项目根目录
# 测试脚本会自动检测并处理
```

### 3. 启动 Web 界面

```bash
# 启动 Gradio 界面
./start_gradio.sh

# 或直接运行
python app_gradio.py
```

### 4. 使用功能

1. 打开浏览器访问 `http://localhost:7860`
2. 在右侧"证件照生成"区域上传照片
3. 在对话框中输入要求：
   - "生成1寸白底证件照"
   - "生成2寸蓝底证件照"
   - "生成护照照片"
   - "支持哪些证件照规格？"

## 💬 使用示例

### 示例 1：生成单个证件照

```
用户: [上传照片] 生成1寸白底证件照

AI: ✅ 已成功生成 1寸 白色底证件照！

📏 尺寸信息：
- 规格：1寸
- 像素：295 x 413 px
- 背景：白色

📥 下载链接：
/static/photos/id_photo_1寸_白色_20240130_153045.jpg

💡 提示：您可以继续要求生成其他尺寸或背景颜色的证件照。
```

### 示例 2：生成多个尺寸

```
用户: 再生成一个2寸蓝底的

AI: ✅ 已成功生成 2寸 蓝色底证件照！

📏 尺寸信息：
- 规格：2寸
- 像素：413 x 579 px
- 背景：蓝色

📥 下载链接：
/static/photos/id_photo_2寸_蓝色_20240130_153102.jpg
```

### 示例 3：查询支持的规格

```
用户: 支持哪些证件照规格？

AI: 📸 证件照生成规格

### 支持的尺寸：
- **1寸**: 295 x 413 px
- **小1寸**: 260 x 378 px
- **2寸**: 413 x 579 px
...

### 支持的背景颜色：
- 白色
- 蓝色
- 红色
- 浅蓝

### 使用方法：
1. 上传您的照片
2. 告诉我需要的尺寸（如"1寸"、"2寸"）
3. 选择背景颜色（如"白色"、"蓝色"）
4. 系统会自动生成并提供下载链接
```

## 🔧 技术实现

### 架构设计

```
用户上传照片
    ↓
Gradio 界面接收
    ↓
保存到临时目录
    ↓
Agent 识别意图
    ↓
调用 generate_id_photo 工具
    ↓
IDPhotoGenerator 处理
    ↓
返回下载链接
```

### 核心模块

1. **app/core/id_photo.py** - 证件照生成核心逻辑
   - `IDPhotoGenerator` 类
   - 人脸检测
   - 背景移除
   - 图像处理

2. **app/core/tools.py** - Agent 工具集成
   - `generate_id_photo` 工具
   - `list_id_photo_specs` 工具

3. **app_gradio.py** - Web 界面
   - 图片上传处理
   - 对话集成
   - 文件管理

### 处理流程

```python
# 1. 人脸检测
face_box = detect_face(image)

# 2. 背景移除
image_no_bg = remove_background(image)

# 3. 智能裁剪
cropped = crop_and_resize(image_no_bg, target_size, face_box)

# 4. 添加背景
result = add_background(cropped, background_color)

# 5. 图像增强
enhanced = enhance_image(result)

# 6. 保存输出
save(enhanced, output_path)
```

## 📸 拍照建议

为了获得最佳效果：

1. ✅ **光线充足** - 使用自然光或柔和的室内光
2. ✅ **背景简洁** - 纯色背景或简单背景
3. ✅ **人脸居中** - 确保人脸在画面中央
4. ✅ **表情自然** - 保持自然表情，眼睛平视
5. ✅ **着装得体** - 穿着正式或半正式服装
6. ✅ **高分辨率** - 使用高分辨率照片（> 1000px）

## 🐛 常见问题

### Q: 人脸检测失败怎么办？

**A:** 系统会自动使用中心裁剪模式。建议：
- 确保人脸清晰可见
- 光线充足
- 人脸正对镜头

### Q: 背景移除效果不好？

**A:** 可以尝试：
- 使用纯色背景拍照
- 确保人物与背景有明显对比
- 调整拍照光线和角度

### Q: 生成的照片在哪里？

**A:** 默认保存在 `app/static/photos/` 目录，文件名格式：
```
id_photo_{尺寸}_{背景色}_{时间戳}.jpg
```

### Q: 如何批量生成多个尺寸？

**A:** 使用 Python 代码：

```python
from app.core.id_photo import IDPhotoGenerator
from PIL import Image

generator = IDPhotoGenerator()
image = Image.open("photo.jpg")

results = generator.generate_multiple(
    image,
    sizes=["1寸", "2寸", "护照"],
    background_color="白色",
    remove_bg=True
)
```

## 📁 文件结构

```
ai_agent_kb/
├── app/
│   ├── core/
│   │   ├── id_photo.py          # 证件照生成核心
│   │   └── tools.py             # Agent 工具集成
│   └── static/
│       ├── photos/              # 生成的证件照
│       └── uploads/             # 上传的原图
├── docs/
│   └── ID_PHOTO_FEATURE.md      # 详细文档
├── test_id_photo.py             # 测试脚本
├── install_id_photo_deps.sh     # 依赖安装脚本
├── README_ID_PHOTO.md           # 快速开始
└── 证件照生成功能说明.md        # 本文档
```

## 🔄 开发进度

- ✅ 核心功能实现
- ✅ Agent 工具集成
- ✅ Gradio 界面更新
- ✅ 测试脚本
- ✅ 完整文档
- ⏳ 依赖安装（需要运行安装脚本）
- ⏳ 功能测试（需要真实照片）
- ⏳ 合并到主分支

## 📚 相关文档

- **详细文档**: [docs/ID_PHOTO_FEATURE.md](docs/ID_PHOTO_FEATURE.md)
- **快速开始**: [README_ID_PHOTO.md](README_ID_PHOTO.md)
- **测试脚本**: [test_id_photo.py](test_id_photo.py)
- **核心代码**: [app/core/id_photo.py](app/core/id_photo.py)

## 🎯 下一步

1. **安装依赖**
   ```bash
   ./install_id_photo_deps.sh
   ```

2. **运行测试**
   ```bash
   python test_id_photo.py
   ```

3. **启动服务**
   ```bash
   ./start_gradio.sh
   ```

4. **体验功能**
   - 上传照片
   - 生成证件照
   - 下载结果

## 💡 提示

- 首次使用 rembg 会自动下载模型（约 176MB）
- 建议使用虚拟环境安装依赖
- 生成的照片会保存在本地，可以直接下载使用
- 支持通过对话方式生成，非常方便

## 🎉 总结

证件照生成功能已经完整实现并集成到 Agent 系统中！现在你可以：

1. ✅ 通过对话生成证件照
2. ✅ 支持 10+ 种标准尺寸
3. ✅ 自动人脸检测和裁剪
4. ✅ 背景移除和替换
5. ✅ 高质量输出

开始使用吧！🚀
