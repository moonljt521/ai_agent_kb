# 证件照显示和下载功能说明

## 问题修复

### 问题1: 下载链接返回 404
**原因**: Gradio 没有配置静态文件访问权限

**解决方案**: 
在 `app_gradio.py` 的 `demo.launch()` 中添加 `allowed_paths` 参数：
```python
demo.launch(
    server_name="0.0.0.0",
    server_port=7860,
    share=False,
    show_error=True,
    allowed_paths=["app/static/photos", "app/static/uploads"]
)
```

### 问题2: 图片无法在聊天框中显示
**原因**: 返回的是纯文本，没有图片标记

**解决方案**:
1. 在 `app/core/tools.py` 的 `generate_id_photo` 函数中添加图片路径标记：
   ```python
   [IMAGE_PATH:{filepath}]
   ```

2. 在 `app_gradio.py` 的 `chat` 函数中解析标记并转换为 Markdown 图片格式：
   ```python
   image_match = re.search(r'\[IMAGE_PATH:(.*?)\]', answer)
   if image_match:
       image_path = image_match.group(1)
       answer = answer.replace(image_match.group(0), "")
       answer = answer.strip() + f"\n\n![生成的证件照]({image_path})"
   ```

## 使用方法

### 1. 上传照片
在 Gradio 界面右侧的"证件照生成"区域上传您的照片

### 2. 生成证件照
在对话框中输入：
- "生成1寸白底证件照"
- "生成2寸蓝底证件照"
- "生成护照照片"

### 3. 查看结果
生成成功后，您会看到：
- ✅ 成功提示
- 📏 尺寸信息
- 📥 下载链接（可点击）
- 🖼️ 图片预览（直接显示在聊天框中）

## 技术细节

### 文件路径处理
1. **绝对路径**: `app/static/photos/id_photo_xxx.jpg` - 用于文件系统访问
2. **相对路径**: `/static/photos/id_photo_xxx.jpg` - 用于 Web 访问
3. **Markdown 图片**: `![alt](path)` - 用于 Gradio 显示

### 静态文件服务
Gradio 通过 `allowed_paths` 参数允许访问指定目录：
- `app/static/photos` - 生成的证件照
- `app/static/uploads` - 用户上传的原始照片

### 图片显示流程
```
工具生成图片 
  → 返回 [IMAGE_PATH:xxx] 标记
  → chat 函数解析标记
  → 转换为 Markdown 格式
  → Gradio 渲染图片
```

## 测试

运行测试脚本：
```bash
python test_id_photo_with_agent.py
```

检查输出中是否包含：
- `[IMAGE_PATH:...]` 标记
- 图片文件已生成
- 无错误信息

## 注意事项

1. **图片格式**: Gradio 支持 JPG、PNG 等常见格式
2. **路径安全**: 只允许访问 `app/static` 下的文件
3. **文件大小**: 建议生成的图片不超过 5MB
4. **浏览器兼容**: 现代浏览器都支持 Markdown 图片显示

## 故障排除

### 问题: 图片不显示
**检查**:
1. 文件是否真的生成了（查看 `app/static/photos/` 目录）
2. 路径是否正确（检查控制台日志）
3. `allowed_paths` 是否配置正确

### 问题: 下载链接 404
**检查**:
1. Gradio 服务是否重启（应用 `allowed_paths` 配置）
2. 路径格式是否正确（应该以 `/static/` 开头）
3. 文件权限是否正确

### 问题: 图片显示但无法下载
**检查**:
1. 浏览器是否阻止下载
2. 文件是否存在
3. 尝试右键"另存为"

## 更新日志

### 2026-02-02
- ✅ 添加静态文件访问配置
- ✅ 实现图片在聊天框中显示
- ✅ 修复下载链接 404 问题
- ✅ 优化图片路径处理
