# 标签 vs 关键词：区别与使用场景

## 快速对比

| 特性 | 关键词（Keywords） | 标签（Tags） |
|------|-------------------|-------------|
| **作用** | 优化检索策略 | 过滤检索范围 |
| **时机** | 查询前判断 | 查询时过滤 |
| **目的** | 提高检索数量 | 缩小检索范围 |
| **配置文件** | `config/keywords.json` | `config/document_tags.json` |
| **影响范围** | 检索参数（k值） | 检索结果（元数据过滤） |
| **使用方式** | 自动匹配 | 用户指定 |

---

## 详细说明

### 关键词（Keywords）

#### 定义
关键词是**预定义的重要词汇列表**，用于判断用户查询是否属于"常见问题"。

#### 作用
当用户查询**命中关键词**时，系统会：
- ✅ 增加检索数量（k=8 而不是 k=5）
- ✅ 获取更全面的信息
- ✅ 提高回答质量

#### 配置位置
`config/keywords.json`

```json
{
  "人物": {
    "红楼梦": ["贾宝玉", "林黛玉", "薛宝钗"],
    "三国演义": ["刘备", "关羽", "张飞", "诸葛亮"],
    "西游记": ["孙悟空", "唐僧", "猪八戒"],
    "水浒传": ["宋江", "林冲", "武松"]
  }
}
```

#### 工作流程

```
用户查询："诸葛亮"
    ↓
关键词匹配 ✅ 命中（在 keywords.json 中）
    ↓
增强检索（k=8，比标准多 60%）
    ↓
检索所有书籍中的 8 个相关文档
    ↓
LLM 处理
    ↓
返回答案
```

#### 特点
- ✅ **自动触发**：用户无需指定，系统自动判断
- ✅ **提高质量**：命中时检索更多文档
- ✅ **全局检索**：仍然搜索所有书籍
- ✅ **优化性能**：针对常见查询优化

#### 示例

```bash
# 查询"诸葛亮"（命中关键词）
curl "http://127.0.0.1:8888/chat?query=诸葛亮"

# 结果：
# - keyword_matched: true
# - retrieved_docs_count: 8
# - 可能返回《三国演义》、《红楼梦》等多本书的内容
```

---

### 标签（Tags）

#### 定义
标签是**文档的元数据属性**，用于描述文档的特征（书名、作者、朝代等）。

#### 作用
用户可以**指定标签**来：
- ✅ 限定检索范围（只在某本书中搜索）
- ✅ 过滤不相关内容
- ✅ 精准定位

#### 配置位置
`config/document_tags.json`

```json
{
  "文档标签映射": {
    "红楼梦": {
      "book": "红楼梦",
      "author": "曹雪芹",
      "dynasty": "清朝",
      "genre": "章回小说"
    },
    "三国演义": {
      "book": "三国演义",
      "author": "罗贯中",
      "dynasty": "东汉末年",
      "genre": "历史演义"
    }
  }
}
```

#### 工作流程

```
用户查询："诸葛亮" + 指定书名："三国演义"
    ↓
向量检索（带标签过滤）
    ↓
只检索《三国演义》中的文档
    ↓
返回 5 个相关文档（只来自《三国演义》）
    ↓
LLM 处理
    ↓
返回答案
```

#### 特点
- ✅ **用户指定**：需要用户明确指定书名
- ✅ **精准过滤**：只返回指定书籍的内容
- ✅ **避免混淆**：不会返回其他书籍的内容
- ✅ **灵活控制**：用户决定是否使用

#### 示例

```bash
# 查询"诸葛亮"（限定《三国演义》）
curl "http://127.0.0.1:8888/chat?query=诸葛亮&book=三国演义"

# 结果：
# - book_filter: "三国演义"
# - retrieved_docs_count: 5
# - 只返回《三国演义》中的内容
```

---

## 对比示例

### 示例 1：查询"宝玉"

#### 只用关键词（不指定书名）

```bash
curl "http://127.0.0.1:8888/chat?query=宝玉"
```

**流程**：
1. 关键词匹配：❌ 未命中（"宝玉"不在 keywords.json 中）
2. 标准检索：k=5
3. 检索范围：所有书籍
4. 可能返回：《红楼梦》的贾宝玉 + 其他书的内容混在一起

**问题**：可能返回不相关的内容

---

#### 使用标签（指定书名）

```bash
curl "http://127.0.0.1:8888/chat?query=宝玉&book=红楼梦"
```

**流程**：
1. 关键词匹配：跳过（因为指定了书名）
2. 标签过滤：只检索《红楼梦》
3. 检索范围：仅《红楼梦》
4. 返回：只有《红楼梦》中关于贾宝玉的内容

**优势**：精准，无干扰

---

### 示例 2：查询"诸葛亮"

#### 只用关键词（不指定书名）

```bash
curl "http://127.0.0.1:8888/chat?query=诸葛亮"
```

**流程**：
1. 关键词匹配：✅ 命中
2. 增强检索：k=8
3. 检索范围：所有书籍
4. 返回：《三国演义》中的诸葛亮（主要）+ 可能有其他书提到的诸葛亮

**优势**：信息全面

---

#### 使用标签（指定书名）

```bash
curl "http://127.0.0.1:8888/chat?query=诸葛亮&book=三国演义"
```

**流程**：
1. 关键词匹配：跳过
2. 标签过滤：只检索《三国演义》
3. 检索范围：仅《三国演义》
4. 返回：只有《三国演义》中的诸葛亮

**优势**：精准，排除干扰

---

## 组合使用

### 最佳实践：关键词 + 标签

```bash
# 查询"诸葛亮"，限定《三国演义》
curl "http://127.0.0.1:8888/chat?query=诸葛亮&book=三国演义"
```

**流程**：
1. 指定了书名，跳过关键词检查
2. 标签过滤：只检索《三国演义》
3. 标准检索：k=5（因为范围已经缩小）
4. 返回：《三国演义》中关于诸葛亮的 5 个文档

**优势**：
- ✅ 精准定位
- ✅ 避免混淆
- ✅ 性能优化（范围小，检索快）

---

## 使用场景

### 场景 1：不确定在哪本书

**需求**：我想了解"诸葛亮"，但不确定在哪本书里

**方案**：只用关键词

```bash
curl "http://127.0.0.1:8888/chat?query=诸葛亮"
```

**结果**：
- 关键词命中 → k=8
- 搜索所有书籍
- 返回全面的信息（主要来自《三国演义》）

---

### 场景 2：明确知道在哪本书

**需求**：我想了解《红楼梦》中的"宝玉"

**方案**：使用标签

```bash
curl "http://127.0.0.1:8888/chat?query=宝玉&book=红楼梦"
```

**结果**：
- 只检索《红楼梦》
- 返回精准的贾宝玉信息
- 不会混入其他书的内容

---

### 场景 3：对比不同书籍

**需求**：对比《红楼梦》和《西游记》中的"爱情"主题

**方案**：分别使用标签

```bash
# 《红楼梦》中的爱情
curl "http://127.0.0.1:8888/chat?query=爱情&book=红楼梦"

# 《西游记》中的爱情
curl "http://127.0.0.1:8888/chat?query=爱情&book=西游记"
```

**结果**：
- 分别获取两本书的内容
- 便于对比分析

---

### 场景 4：探索性查询

**需求**：我想了解"潘巧云"，不知道在哪本书

**方案**：不用关键词和标签

```bash
curl "http://127.0.0.1:8888/chat?query=潘巧云"
```

**结果**：
- 关键词未命中 → k=5
- 搜索所有书籍
- 返回《水浒传》中的潘巧云

---

## 技术实现

### 关键词实现

```python
# app/core/agent.py

def run(self, query: str):
    # 检查关键词
    if self.enable_direct_retrieval:
        should_direct, reason = self.keyword_matcher.should_use_direct_retrieval(query)
        
        if should_direct:
            # 命中关键词：k=8
            return self.run_simple_rag(query, keyword_matched=True)
    
    # 未命中：k=5
    return self.run_simple_rag(query, keyword_matched=False)
```

### 标签实现

```python
# app/core/rag.py

def search_by_book(self, query: str, book_name: str, k=5):
    """按书名检索"""
    results = self.vector_store.similarity_search(
        query,
        k=k,
        filter={"book": book_name}  # 元数据过滤
    )
    return results
```

---

## 配置管理

### 关键词配置

**文件**：`config/keywords.json`

**内容**：341 个关键词

**修改后**：无需重新导入文档，立即生效

```bash
# 修改关键词
vim config/keywords.json

# 重启服务即可
./start_web.sh
```

### 标签配置

**文件**：`config/document_tags.json`

**内容**：4 本书的标签映射

**修改后**：必须重新导入文档

```bash
# 修改标签
vim config/document_tags.json

# 重新导入文档
rm -rf vector_store
python scripts/ingest.py
```

---

## 性能对比

| 场景 | 关键词 | 标签 | 检索数量 | 检索范围 |
|------|--------|------|---------|---------|
| 查询"诸葛亮" | ✅ 命中 | ❌ 未用 | k=8 | 所有书籍 |
| 查询"诸葛亮"，指定《三国演义》 | ❌ 跳过 | ✅ 使用 | k=5 | 仅《三国演义》 |
| 查询"潘巧云" | ❌ 未命中 | ❌ 未用 | k=5 | 所有书籍 |
| 查询"潘巧云"，指定《水浒传》 | ❌ 跳过 | ✅ 使用 | k=5 | 仅《水浒传》 |

---

## 总结

### 关键词（Keywords）

**本质**：查询优化策略  
**作用**：命中时增加检索数量  
**优势**：自动触发，提高常见查询质量  
**劣势**：不能限定检索范围  

**适用场景**：
- ✅ 不确定在哪本书
- ✅ 想要全面的信息
- ✅ 常见人物、地点查询

---

### 标签（Tags）

**本质**：文档元数据过滤  
**作用**：限定检索范围  
**优势**：精准定位，避免混淆  
**劣势**：需要用户指定  

**适用场景**：
- ✅ 明确知道在哪本书
- ✅ 避免不同书籍内容混淆
- ✅ 对比分析不同书籍

---

### 最佳实践

1. **探索性查询**：不用标签，让关键词自动优化
2. **精准查询**：使用标签限定书名
3. **对比分析**：分别使用标签查询不同书籍
4. **常见问题**：依赖关键词自动优化

---

**两者互补，各有用途！** 🎯
