# 📊 向量数据库详解

## 什么是 vector_store？

`vector_store/` 目录存储的是**向量数据库**，它是 RAG（检索增强生成）系统的核心组件。

## 工作原理

### 1. 文档导入流程

```
原始文档 (PDF/EPUB/TXT)
    ↓
文本提取
    ↓
文本切片 (每块 1000 字符)
    ↓
向量化 (text-embedding-v3)
    ↓
存储到 vector_store/
```

### 2. 查询流程

```
用户问题
    ↓
问题向量化
    ↓
在 vector_store 中搜索相似向量
    ↓
返回最相关的文档片段 (Top 3)
    ↓
LLM 基于这些片段生成答案
```

## 文件结构

```
vector_store/
├── chroma.sqlite3                          # 主数据库 (36MB)
└── 90fa9f25-8bab-4e9c-9d92-6eab7df1b7d4/  # 向量索引目录
    ├── data_level0.bin                     # 向量数据 (5.4MB)
    ├── header.bin                          # 索引头信息 (100B)
    ├── index_metadata.pickle               # 索引元数据 (120KB)
    ├── length.bin                          # 向量长度信息 (5.2KB)
    └── link_lists.bin                      # 向量链接列表 (11KB)
```

## 文件说明

### 1. chroma.sqlite3 (36MB)
**作用**：主数据库文件

**存储内容**：
- 文档的原始文本片段
- 文档元数据（来源、页码等）
- 向量 ID 和文档 ID 的映射关系
- 集合（Collection）信息

**为什么这么大？**
- 存储了《红楼梦》全文的所有文本片段
- 每个片段约 1000 字符
- 包含了所有的元数据信息

### 2. 向量索引目录 (90fa9f25-...)
**作用**：HNSW（Hierarchical Navigable Small World）向量索引

这是一个高效的向量搜索索引，用于快速找到相似的向量。

#### data_level0.bin (5.4MB)
- **存储**：所有文档片段的向量表示
- **格式**：二进制浮点数数组
- **维度**：每个向量 1536 维（text-embedding-v3 的输出维度）
- **数量**：约 3000+ 个向量（取决于文档大小）

#### header.bin (100B)
- **存储**：索引的头信息
- **内容**：版本号、配置参数等

#### index_metadata.pickle (120KB)
- **存储**：索引的元数据
- **内容**：向量数量、维度、距离度量方式等
- **格式**：Python pickle 序列化格式

#### length.bin (5.2KB)
- **存储**：每个向量的长度信息
- **用途**：用于归一化和距离计算

#### link_lists.bin (11KB)
- **存储**：HNSW 图的连接关系
- **用途**：快速导航到相似向量

## 向量化示例

### 原始文本
```
"贾宝玉是《红楼梦》的主人公，他生于贾府..."
```

### 向量化后
```
[0.023, -0.145, 0.891, ..., 0.234]  # 1536 个浮点数
```

### 相似度计算
当你问"贾宝玉是谁"时：
1. 问题被向量化：`[0.021, -0.143, 0.889, ...]`
2. 在数据库中搜索最相似的向量
3. 返回相似度最高的 3 个文档片段

## 数据统计

以你的《红楼梦》为例：

```bash
# 查看数据库大小
du -sh vector_store/
# 输出：42M

# 查看文档数量
sqlite3 vector_store/chroma.sqlite3 "SELECT COUNT(*) FROM embeddings;"
# 输出：约 3000+ 条记录
```

## 为什么需要向量数据库？

### 传统关键词搜索
```
问题："宝玉的性格"
搜索：只能找到包含"宝玉"和"性格"这两个词的句子
```

### 向量搜索（语义搜索）
```
问题："宝玉的性格"
搜索：能找到描述宝玉性格的所有相关内容，即使没有直接出现"性格"这个词

例如能找到：
- "宝玉生性顽劣"
- "他最是怜香惜玉"
- "宝玉素日不喜读书"
```

## 向量相似度

向量之间的相似度通常用**余弦相似度**或**欧氏距离**计算：

```python
# 余弦相似度（值越大越相似，范围 -1 到 1）
similarity = cosine_similarity(query_vector, doc_vector)

# 例如：
# "贾宝玉" 和 "宝玉" → 0.95（非常相似）
# "贾宝玉" 和 "林黛玉" → 0.75（相关）
# "贾宝玉" 和 "天气" → 0.15（不相关）
```

## 管理操作

### 查看数据库信息
```bash
# 查看大小
du -sh vector_store/

# 查看文件数量
find vector_store/ -type f | wc -l
```

### 清空数据库
```bash
rm -rf vector_store/
```

### 重建数据库
```bash
python scripts/ingest.py
```

### 备份数据库
```bash
cp -r vector_store/ vector_store_backup/
```

## 性能优化

### 1. 索引大小
- 文档越多，索引越大
- 建议单个数据库 < 10GB

### 2. 检索速度
- HNSW 索引：O(log n) 复杂度
- 3000 个向量：< 10ms
- 100万 个向量：< 100ms

### 3. 内存占用
- 加载时会占用内存
- 约为索引大小的 1-2 倍
- 42MB 索引 → 约 80MB 内存

## 常见问题

### Q: 为什么 chroma.sqlite3 这么大？
A: 它存储了所有文档的原始文本和元数据，不只是向量。

### Q: 可以手动编辑这些文件吗？
A: 不建议。这些是二进制文件，应该通过代码操作。

### Q: 向量数据库会过期吗？
A: 不会。除非你更新了文档，否则可以一直使用。

### Q: 可以合并多个向量数据库吗？
A: 不能直接合并。需要重新导入所有文档。

### Q: 删除文档后需要重建吗？
A: 是的。删除或更新文档后，需要清空并重建向量数据库。

## 技术细节

### 使用的技术
- **向量数据库**：ChromaDB
- **向量索引**：HNSW (Hierarchical Navigable Small World)
- **向量模型**：阿里云 text-embedding-v3
- **向量维度**：1536
- **距离度量**：余弦相似度

### 配置参数
```python
# 在 app/core/rag.py 中
text_splitter = RecursiveCharacterTextSplitter(
    chunk_size=1000,      # 每个片段 1000 字符
    chunk_overlap=100     # 片段之间重叠 100 字符
)

retriever = vector_store.as_retriever(
    search_kwargs={"k": 3}  # 返回最相似的 3 个片段
)
```

## 总结

`vector_store/` 是一个**智能搜索引擎**：
- 将文档转换为数学向量
- 通过向量相似度进行语义搜索
- 比传统关键词搜索更智能
- 是 RAG 系统的核心组件

就像给文档建立了一个"语义索引"，让 AI 能够理解和搜索文档内容！
