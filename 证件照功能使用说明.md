# 📸 证件照生成功能使用说明

## 问题解决

### 之前的问题
用户报告：生成证件照失败，提示"未找到图片文件"

### 根本原因
Agent 在调用 `generate_id_photo` 工具时，LangChain 的参数解析将整个 JSON 对象作为第一个参数传递，导致路径错误。

### 解决方案
在 `app/core/tools.py` 的 `generate_id_photo` 函数中添加了 JSON 参数解析逻辑：
```python
# 如果 image_path 是 JSON 字符串，尝试解析
if isinstance(image_path, str) and image_path.strip().startswith('{'):
    try:
        params = json.loads(image_path)
        image_path = params.get('image_path', image_path)
        size = params.get('size', size)
        background = params.get('background', background)
        remove_background = params.get('remove_background', remove_background)
    except json.JSONDecodeError:
        pass
```

## 使用方法

### 步骤1: 访问 Web 界面
打开浏览器访问：http://localhost:7860

### 步骤2: 上传照片
1. 在右侧"证件照生成"区域点击上传按钮
2. 选择您的照片（支持 JPG、PNG 格式）
3. 等待上传成功提示

### 步骤3: 生成证件照
在对话框中输入您的需求，例如：
- "生成1寸白底证件照"
- "生成2寸蓝底证件照"
- "生成护照照片"
- "生成身份证规格红底证件照"

### 步骤4: 下载照片
Agent 会返回生成的证件照信息和下载链接，点击链接即可下载。

## 支持的规格

### 尺寸
- 1寸: 295 x 413 px
- 小1寸: 260 x 378 px
- 2寸: 413 x 579 px
- 小2寸: 378 x 567 px
- 大1寸: 390 x 567 px
- 护照: 354 x 472 px
- 身份证: 358 x 441 px
- 驾驶证: 260 x 378 px
- 社保卡: 358 x 441 px
- 教师资格证: 295 x 413 px

### 背景颜色
- 白色
- 蓝色
- 红色
- 浅蓝

## 功能特点

✅ 自动人脸检测和智能裁剪
✅ 背景移除和替换（需要 rembg 库）
✅ 图像质量增强
✅ 高清输出（300 DPI）
✅ 支持多种标准尺寸
✅ 支持多种背景颜色

## 测试

运行测试脚本验证功能：
```bash
python test_id_photo_with_agent.py
```

## 注意事项

1. **照片要求**：
   - 正面免冠照
   - 人脸清晰可见
   - 光线充足
   - 建议使用高分辨率照片

2. **背景移除**：
   - 如果 rembg 库未完全安装，会使用原图背景
   - 可以运行 `./install_id_photo_deps.sh` 安装完整依赖

3. **文件存储**：
   - 上传的照片保存在 `app/static/uploads/`
   - 生成的证件照保存在 `app/static/photos/`

## 技术细节

### 修改的文件
1. `app/core/tools.py` - 添加 JSON 参数解析
2. `app_gradio.py` - 改进图片路径传递格式
3. `app/core/agent.py` - 使用 ReAct Agent 实现

### 工作流程
1. 用户上传照片 → 保存到 `app/static/uploads/`
2. 用户发送生成请求 → Gradio 自动添加图片路径到消息
3. Agent 解析请求 → 调用 `generate_id_photo` 工具
4. 工具解析参数 → 生成证件照
5. 返回结果 → 提供下载链接

## 故障排除

### 问题：上传后提示找不到文件
**解决**：
- 确保 `app/static/uploads/` 目录存在且有写权限
- 检查上传是否成功（查看上传状态提示）
- 重新上传照片

### 问题：生成的照片质量不好
**解决**：
- 使用更高分辨率的原始照片
- 确保原始照片光线充足、人脸清晰
- 尝试不同的背景颜色

### 问题：背景移除失败
**解决**：
- 运行 `./install_id_photo_deps.sh` 安装完整依赖
- 或者使用原图背景（系统会自动降级）

## 更新日志

### 2026-02-02
- ✅ 修复 Agent 参数解析问题
- ✅ 改进错误提示信息
- ✅ 优化图片路径传递方式
- ✅ 添加完整测试脚本
